// twitterlib.js (c) 2011 Remy Sharp
// @version 1.1.3 / Thu May 23 06:30:34 2013 -0700
// MIT license: http://rem.mit-license.org
(function(e){function w(e){var n='<li><div class="tweet">';return n+='<div class="vcard"><a href="http://twitter.com/'+e.user.screen_name+'" class="url"><img style="height: 48px; width: 48px;" alt="'+e.user.name+'" class="photo fn" height="48" src="'+e.user.profile_image_url+'" width="48" /></a></div>',n+='<div class="hentry"><strong><a href="http://twitter.com/',n+=e.user.screen_name+'" ',n+='title="'+e.user.name+'">'+e.user.screen_name+"</a></strong> ",n+='<span class="entry-content">',n+=t.ify.clean(e.text),n+='</span> <span class="meta entry-meta"><a href="http://twitter.com/'+e.user.screen_name,n+="/status/"+e.id_str+'" class="entry-date" rel="bookmark"><span class="published" title="',n+=t.time.datetime(e.created_at)+'">'+t.time.relative(e.created_at)+"</span></a>",e.source&&(n+=" <span>from "+e.source+"</span>"),e.retweetedby&&(n+=" <span>retweeted by "+e.retweetedby.screen_name+"</span>"),n+="</span></div></div></li>",n}function E(e){var n=o.getElementById(t+e);n&&u.removeChild(o.getElementById(t+e)),delete f[t+e],s[t+e]=d;try{delete s[t+e]}catch(r){}}function S(e,n,r){var a=o.createElement("script"),l=null;n==d&&(n={}),i++,f["twitterlib"+i]=!0,s["twitterlib"+i]=function(e,n){return function(i){var s=0,o=[];s=i.length;while(s--)i[s].originalText=i[s].text,i[s].text=g(i[s]);if(i.results){i=i.results,s=i.length;while(s--)i[s].user={id:i[s].from_user_id,screen_name:i[s].from_user,profile_image_url:i[s].profile_image_url},i[s].source=t.ify.entities(i[s].source),o=i[s].created_at.split(" "),i[s].created_at=[o[0],o[2],o[1],o[4],o[5],o[3]].join(" ").replace(/,/,"")}else if(i.length&&i[0].sender){s=i.length;while(s--)i[s].user=i[s].sender,i[s].originalText=i[s].text,i[s].text="@"+i[s].recipient_screen_name+" "+i[s].text}else if(n.rts==1||n.rts=="t"||n.rts==1){s=i.length;while(s--)i[s].retweeted_status&&(i[s].retweeted_status.retweetedby=i[s].user,i[s]=i[s].retweeted_status)}n.originalTweets=i,n.filter&&(i=b.matchTweets(i,n.filter)),n.limit&&n.limit<i.length&&(i=i.splice(0,n.limit));if(v&&n.page>1)try{sessionStorage.setItem("twitterlib.page"+n.page+".tweets",JSON.stringify(i)),sessionStorage.setItem("twitterlib.page"+n.page+".originalTweets",JSON.stringify(n.originalTweets)),sessionStorage.setItem("twitterlib.page"+n.page,"true")}catch(u){}n.cached=!1,r.call(t,i,n),E(e)}}(i,n),l=e.match(/callback=(.*)/),l!=null&&l.length>1?s[l[1]]=s["twitterlib"+i]:e+="&callback=twitterlib"+i;if(!v||n.page<=1||v&&sessionStorage.getItem("twitterlib.page"+n.page)==null)a.src=e,a.id="twitterlib"+i,u.appendChild(a);else if(v){E(i),n.cached=!0,n.originalTweets=JSON.parse(sessionStorage.getItem("twitterlib.page"+n.page+".originalTweets"));var c=JSON.parse(sessionStorage.getItem("twitterlib.page"+n.page+".tweets")||"[]");n.filter&&(c=b.matchTweets(c,n.filter)),n.limit&&n.limit<c.length&&(c=c.splice(0,n.limit)),r.call(t,c,n)}}function x(e,t){return t=t||{},p[e].replace(/(\b.*?)%(.*?)(\|.*?)?%/g,function(e,n,r,i){if(i&&i.substr(1)=="remove"&&t[r]==d)return"";var s=r=="limit"?t[r]+10:t[r];return n+(t[r]===d&&i!==d?i.substr(1):s)})+(this.accessToken?"&access_token="+this.accessToken:"")}function T(e,t){return typeof e=="function"&&(t=e,e={}),e===d&&(e={}),e.page=e.page||1,e.callback=t,e.limit===0&&delete e.limit,e}function N(e,t,n){a={method:e,arg:t,options:n,callback:n.callback,page:n.page||1},n.method=e;if(v){var r=JSON.parse(sessionStorage.getItem("twitterlib.last_request")||"{}");if(a.method!=r.method||a.arg!=r.arg)C(),sessionStorage.setItem("twitterlib.last_request",JSON.stringify(a))}}function C(){var e=sessionStorage.length;while(e--)sessionStorage.key(e).substr(0,"twitterlib".length)=="twitterlib"&&sessionStorage.removeItem(sessionStorage.key(e))}function k(e,t,n){return t&&p[e]==d&&(p[e]=t),this[e]==d&&(this[e]=function(t,n,r){return typeof t=="function"?(r=t,t=""):t.toString()=="[Object object]"&&(r=n,n=t,t=""),n=T(n,r),N(e,t,n),n[e]=n.user=t,n.search=encodeURIComponent(t),n.callback&&S(x(e,n),n,n.callback),this}),this[e]}var t={};if(typeof exports!="undefined"&&typeof require=="function"){var n=require("url").parse,r=require("http");this.document={location:{protocol:"http:"},head:{appendChild:function(e){if(!e.src)return;var t=n(e.src,!0),i=r.request(t),o="",u=s[t.query.callback];i.on("response",function(e){e.setEncoding("utf8"),e.on("data",function(e){o+=e}).on("end",function(){switch(e.statusCode){case 200:o=o.replace(new RegExp("^"+t.query.callback+"\\("),"").replace(/\);*$/,""),f[t.query.callback]&&u(JSON.parse(o));break;case 304:break;case 401:}})}).end()}},getElementById:function(){},createElement:function(e){return{type:e,id:null,src:""}}}}var i=+(new Date),s=this,o=s.document,u=o.head||o.getElementsByTagName("head")[0],a={},f={},l={"&quot;":'"',"&lt;":"<","&gt;":">"},c=o.location.protocol.substr(0,4)==="http"?o.location.protocol:"http:",h={search:c+"//twitter.com/search.json?q=%search%&page=%page|1%&rpp=%limit|100%&since_id=%since|remove%&result_type=recent&include_entities=true",timeline:c+"//api.twitter.com/1/statuses/user_timeline.json?screen_name=%user%&count=%limit|200%&page=%page|1%&since_id=%since|remove%include_rts=%rts|false%&include_entities=true",list:c+"//api.twitter.com/1/%user%/lists/%list%/statuses.json?page=%page|1%&per_page=%limit|200%&since_id=%since|remove%&include_entities=true&include_rts=%rts|false%",favs:c+"//api.twitter.com/1/favorites/%user%.json?include_entities=true&skip_status=true&page=%page|1%&since_id=%since|remove%",retweets:c+"//api.twitter.com/1/statuses/retweeted_by_user.json?screen_name=%user%&include_entities=true&count=%limit|200%&since_id=%since|remove%&page=%page|1%"},p=h,d,v=!1,m=function(){return{entities:function(e){return e.replace(/(&[a-z0-9]+;)/g,function(e){return l[e]})},link:function(e){return e.replace(/[a-z]+:\/\/([a-z0-9-_]+\.[a-z0-9-_:~\+#%&\?\/.=]+[^:\.,\)\s*$])/ig,function(e,t){return'<a title="'+e+'" href="'+e+'">'+(t.length>36?t.substr(0,35)+"&hellip;":t)+"</a>"})},at:function(e){return e.replace(/(^|[^\w]+)\@([a-zA-Z0-9_]{1,15}(\/[a-zA-Z0-9-_]+)*)/g,function(e,t,n){return t+'<a href="http://twitter.com/'+n+'">@'+n+"</a>"})},hash:function(e){return e.replace(/(^|[^&\w'"]+)\#([a-zA-Z0-9_^"^<]+)/g,function(e,t,n){return e.substr(-1)==='"'||e.substr(-1)=="<"?e:t+'<a href="http://twitter.com/search?q=%23'+n+'">#'+n+"</a>"})},clean:function(e){return this.hash(this.at(this.link(e)))}}}(),g=function(e){if(e===d)return"";var t=e.text,n=0;if(e.entities){if(e.entities.urls&&e.entities.urls.length)for(n=0;n<e.entities.urls.length;n++)e.entities.urls[n].expanded_url&&(t=t.replace(e.entities.urls[n].url,e.entities.urls[n].expanded_url));if(e.entities.media&&e.entities.media.length)for(n=0;n<e.entities.media.length;n++)if(e.entities.media[n].media_url||e.entities.media[n].expanded_url)t=t.replace(e.entities.media[n].url,e.entities.media[n].media_url?e.entities.media[n].media_url:e.entities.media[n].expanded_url)}return t},y=function(){var e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return{time:function(e){var t=e.getHours(),n=e.getMinutes()+"",r="AM";return t==0?t=12:t==12?r="PM":t>12&&(t-=12,r="PM"),n.length==1&&(n="0"+n),t+":"+n+" "+r},date:function(t){var n=e[t.getMonth()],r=t.getDate()+"",i=~~r,s=t.getFullYear(),o=(new Date).getFullYear(),u="th";return i%10==1&&r.substr(0,1)!="1"?u="st":i%10==2&&r.substr(0,1)!="1"?u="nd":i%10==3&&r.substr(0,1)!="1"&&(u="rd"),r.substr(0,1)=="0"&&(r=r.substr(1)),n+" "+r+u+(o!=s?", "+s:"")},shortdate:function(t){var n=t.split(" "),r=Date.parse(n[1]+" "+n[2]+", "+n[5]+" "+n[3]),i=new Date(r),s=e[i.getMonth()],o=i.getDate()+"",u=i.getFullYear(),a=(new Date).getFullYear();return a===u?o+" "+s:o+" "+s+(u+"").substr(2,2)},datetime:function(e){var t=e.split(" "),n=new Date(Date.parse(t[1]+" "+t[2]+", "+t[5]+" "+t[3]));return this.time(n)+" "+this.date(n)},relative:function(e){var t=e.split(" "),n=Date.parse(t[1]+" "+t[2]+", "+t[5]+" "+t[3]),r=new Date(n),i=arguments.length>1?arguments[1]:new Date,s=~~((i.getTime()-n)/1e3),o="";return s+=i.getTimezoneOffset()*60,s<=1?o="1 second ago":s<60?o=s+" seconds ago":s<120?o="1 minute ago":s<2700?o=~~(s/60)+" minutes ago":s<10800?o="1 hour ago":s<86400?o=~~(s/3600)+" hours ago":o=this.shortdate(e),o}}}(),b=function(){return{match:function(e,t,n){var r=0,i="",s=e.text.toLowerCase(),o=(!t.and||!t.and.length)&&(!t.or||!t.or.length);typeof t=="string"&&(t=this.format(t));if(t.not&&t.not.length){for(r=0;r<t.not.length;r++)if(s.indexOf(t.not[r])!==-1)return!1;if(o)return!0}else if({}.toString.call(t.not)!=="[object Array]"){if(t.not.test(s))return!1;if(o)return!0}if(t.and&&t.and.length)for(r=0;r<t.and.length;r++){i=t.and[r];if(i.substr(0,3)==="to:"){if(!RegExp("^@"+i.substr(3)).test(s))return!1}else if(i.substr(0,5)=="from:"){if(e.user.screen_name!==i.substr(5))return!1}else if(s.indexOf(i)===-1)return!1}else if(typeof t["and"]=="function"&&t.and.test(s))return!0;if(t.or&&t.or.length)for(r=0;r<t.or.length;r++){i=t.or[r];if(i.substr(0,3)==="to:"){if(RegExp("^@"+i.substr(3)).test(s))return!0}else if(i.substr(0,5)=="from:"){if(e.user.screen_name===i.substr(5))return!0}else if(s.indexOf(t.or[r])!==-1)return!0}else if(typeof t["or"]=="function"){if(t.or.test(s))return!0}else if(t.and&&t.and.length)return!0;return!1},format:function(e,t){var n=[],r=[],i=[],s=0,o=[],u="",a="";e.replace(/(-?["'](.*?)["']|\S+)/g,function(e){var t=!1;e.substr(0,1)=="-"&&(t=!0),e=e.replace(/["']+|["']+$/g,""),t?o.push(e.substr(1).toLowerCase()):n.push(e)});for(s=0;s<n.length;s++)n[s]=="OR"&&n[s+1]?(r.push(n[s-1].toLowerCase()),r.push(n[s+1].toLowerCase()),s++,i.pop()):i.push(n[s].toLowerCase());return{or:r,and:i,not:o}},matchTweets:function(e,t,n){var r=[],i,s=0;typeof t=="string"&&(t=this.format(t));for(s=0;s<e.length;s++)this.match(e[s],t,n)&&r.push(e[s]);return r}}}();t={version:"1.1.3",custom:k,getUrl:x,status:function(e,t,n){return t=T(t,n),t.limit=1,N("status",e,t),this.timeline(e,t,t.callback)},list:function(e,t,n){var r=e.split("/");return t=T(t,n),N("list",e,t),t.user=r[0],t.list=r[1],t.callback&&S(x("list",t),t,t.callback),this},next:function(){return a.method&&(a.page++,a.options.page=a.page,this[a.method](a.arg,a.options,a.callback)),this},refresh:function(){return a.method&&this[a.method](a.arg,a.options,a.callback),this},time:y,ify:m,filter:b,expandLinks:g,cancel:function(){for(var e in f)s[e]=function(){return function(e){E(e)}}(e.replace("twitterlib",""));return f={},this},reset:function(){p=h,a.method=""},render:w,debug:function(e){for(var t in e)p[t]=e[t];return this},cache:function(e){v=e==d?!0:e;if(!s.JSON||!s.sessionStorage)v=!1},setAccessToken:function(e){return this.accessToken=e,this}},t.custom("search"),t.custom("timeline"),t.custom("favs"),t.custom("retweets"),typeof exports!="undefined"&&(module.exports=t),e.twitterlib=t})(this);